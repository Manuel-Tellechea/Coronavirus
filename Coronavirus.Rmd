---
title: "Coronavirus"
author: "María A. Ramírez y Manuel A. Tellechea"
date: "3/29/2020"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Situación COVID-19 en España

Toda la data utilizada para representar la siguiente información, proviene de la página oficial del Ministerio de Sanidad del Gobierno Español <https://covid19.isciii.es>.


```{r setup, include=FALSE}
library(formattable)
library(lubridate)
library(ggplot2)
library(ggpmisc)
library(RColorBrewer)
library(knitr)
library(plot3D)
library(scatterplot3d)
library(grid)
library(gridExtra)
library(dplyr)
library(data.table)
```

```{r cars}
data <- read.csv("serie_historica_acumulados.csv", header = TRUE)
data[is.na(data)] = 0
dim(data)
n <- nrow(data)
data <-data[-c(n),] #borrando el comentario inserto en la última fila
Fecha <- dmy(data$Fecha)
data <- cbind(Fecha, data[,-2])
data
names(data)
data <- data[, c("CCAA.Codigo.ISO", "Fecha", "Casos", "Hospitalizados", "UCI", "Fallecidos")]
data
```

```{r}
data_total <- aggregate(x = data[c("Casos","Hospitalizados", "UCI", "Fallecidos")],
                     FUN = sum,
                     by = list(Group.date = data$Fecha))
data_total
names(data_total)
names(data_total) <- c("Fecha", "Casos", "Hospitalizados", "UCI", "Fallecidos")
data_total

```


## Agrupación de datos por Provincia

```{r}
data_AN <- filter(data, CCAA.Codigo.ISO == "AN")
data_AR <- filter(data, CCAA.Codigo.ISO == "AR")
data_AS <- filter(data, CCAA.Codigo.ISO == "AS")
data_IB <- filter(data, CCAA.Codigo.ISO == "IB")
data_CN <- filter(data, CCAA.Codigo.ISO == "CN")
data_CB <- filter(data, CCAA.Codigo.ISO == "CB")
data_CM <- filter(data, CCAA.Codigo.ISO == "CM")
data_CL <- filter(data, CCAA.Codigo.ISO == "CL")
data_CT <- filter(data, CCAA.Codigo.ISO == "CT")
data_CE <- filter(data, CCAA.Codigo.ISO == "CE")
data_VC <- filter(data, CCAA.Codigo.ISO == "VC")
data_EX <- filter(data, CCAA.Codigo.ISO == "EX")
data_GA <- filter(data, CCAA.Codigo.ISO == "GA")
data_MD <- filter(data, CCAA.Codigo.ISO == "MD")
data_ME <- filter(data, CCAA.Codigo.ISO == "ME")
data_MC <- filter(data, CCAA.Codigo.ISO == "MC")
data_NC <- filter(data, CCAA.Codigo.ISO == "NC")
data_PV <- filter(data, CCAA.Codigo.ISO == "PV")
data_RI <- filter(data, CCAA.Codigo.ISO == "RI")
```



## Gráficos


```{r}

g <- ggplot(data = data_total) + geom_point(mapping = aes(x = Fecha, y = Casos, color = "España")) +
  labs(title = "Casos Confirmados", caption = "Data from: https://covid19.isciii.es") + 
  labs(subtitle = date()) +
  labs(x = "Fecha", y = "Cantidad") +
  geom_point(data_MD, mapping = aes(x = Fecha, y = Casos, color = "Madrid"))
g + theme_classic() + guides(colour = guide_legend("Provincias"))
```


```{r}

ggplot(data = data) +
  geom_smooth(mapping = aes(x = Fecha, y = Casos, group = CCAA.Codigo.ISO, color = CCAA.Codigo.ISO))

```


```{r}
grid.arrange(p1, p2, p3, p4, ncol = 2) #Varios gráficos en un mismo panel
```


# Modelo SIR

You can also embed plots, for example:

```{r pressure, echo=FALSE}
library(deSolve)
#tamaño poblacional
N = 1
#estado inicial de los compartimentos
init <- c(S = 1-1e-6,
          I = 1e-6,
          R = 0)
#parámetros del modelo (coeficientes de las variables)
param <- c(beta = 1.4247,
           gamma = 0.14286)
#crear la función con las ODE
sir <- function(times, init, param) {
  with(as.list(c(init, param)), {
#ecuaciones diferenciales   
    dS <- -beta * S * I
    dI <-  beta * S * I - gamma * I
    dR <-                 gamma * I
#resultados de las tasas de cambio    
    return(list(c(dS, dI, dR)))
  })
}
#intervalo de tiempo y resolución
times <- seq(0, 70, by = 1)
#resolver el sistema de ecuaciones con función 'ode'
out <- ode(y = init, times = times, func = sir, parms = param)
#cambiar out a un data.frame
out <- as.data.frame(out*N) #aqui puede multiplicar 'out' por N
#eliminar la variable 'time' en out
out$time <- NULL
#mostrar 10 primeros datos
head(out, 10)

#gráfica
matplot(x = times, y = out, type = "l",
        xlab = "Tiempo", ylab = "S, I, R", main = "Modelo SIR básico",
        lwd = 1, lty = 1, bty = "l", col = 2:4)
#añadir leyenda de líneas
legend(40, 0.7, c("Susceptibles", "Infectados", "Recuperados"), 
       pch = 1, col = 2:4, bty = "n", cex = 1)

```

Note that the `echo =4 FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
